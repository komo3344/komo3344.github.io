---
title : Django + Vue Project - (1)
date : 2019-12-16
tags:
    - JWT
    - Django
categories:
    - Django
---

# 프로젝트 목표
django와 Vue를 사용하여 Microservices architecture 구현

oauth및 jwt에 대한 정보는 <https://komo3344.github.io/oauth-jwt/> 참고

***

# Django 프로젝트 및 앱 생성 후 셋팅
(project 이름은 MSA_project로 하였고 app 이름은 app으로 정하였다.)  
Django의 강력한 REST framework인 drf와 jwt토큰사용을 위한 drf-jwt설치

```shell
pip install djangoframework
pip install djangoframework-jwt
```

jwt사용을 위해 세팅파일에 아래와 같이 추가해준다.  

**MSA_projectsettings.py**
```
INSTALLED_APPS = [
    ...
    'app',  # app이름
    'rest_framework',
]

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_jwt.authentication.JSONWebTokenAuthentication',
    ),
}

JWT_AUTH = {
    'JWT_SECRET_KEY': SECRET_KEY,
    'JWT_ALGORITHM': 'HS256',
    'JWT_ALLOW_REFRESH': True,
    'JWT_EXPIRATION_DELTA': datetime.timedelta(days=1),  # 유효기간
    'JWT_REFRESH_EXPIRATION_DELTA': datetime.timedelta(days=7),  # 갱신기간
}
```
해당 url로 들어갔을 때 
obtain_jwt_token은 사용자의 id, password를 통해 token을 획득할 수 있다.  
refresh_jwt_token은 만료되지 않은 유효한 토큰을 이용하여토큰을 재발급 받을 수 있다.  
verify_jwt_token은 해당 토큰이 유효한지 확인가능하다.  

**MSA_project/urls.py**
```
from django.contrib import admin
from django.urls import path, include
from rest_framework_jwt.views import obtain_jwt_token, refresh_jwt_token, verify_jwt_token
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('app.urls')),
    path('api-token-auth/', obtain_jwt_token),  # 토큰발급
    path('api-token-refresh/', refresh_jwt_token),  # 새 토큰 발급 
    path('api-token-verity/', verify_jwt_token),    # 토큰 유효성검사
]

```
유저 모델링  

**app/models.py**
```
from django.db import models
from django.contrib.auth.models import AbstractUser


class User(AbstractUser):
    age = models.IntegerField(null=True, blank=True)

    def __str__(self):
        return str(self.username)
```
유저 모델링 작업을 한 후 DB적용을 위해 migrate를 해주어야 한다.

```shell
python manage.py makemigrations
python manage.py migrate
```

AbstractUser를 사용하여 장고에서 제공되는 상속된 유저를 사용할 경우 settings.py에 아래와 같이 추가해준다.  
**settings.py**

```
AUTH_USER_MODEL = 'app.User'
```
데이터를 json형태로 바꿔주기 위해 app 안에 serializers 파일을 생성후 아래 코드를 작성한다.

**app/serializers.py**
```
from rest_framework import serializers
from .models import User


class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = '__all__'

```

로직관련된 부분은 views.py에 작성한다.  
유저 목록을 보거나 유저를 생성 할 수 있는 API이다.  
인증된 사용자만 API를 사용할 수 있도록 권한을 걸어둔다.  

**app/views.py**
```
from rest_framework import generics, permissions
from .models import User
from .serializers import UserSerializer


class UserList(generics.ListCreateAPIView):
    permission_classes = [permissions.IsAuthenticated]
    queryset = User.objects.all()
    serializer_class = UserSerializer
```
로직부분을 작성 했으니 url주소와 연결하여 준다.  
http:localhost:8000/user 로 접속을 했을 때 views에서 작성한 로직이 실행되도록 한다.  

**app/urls.py**
```
from django.urls import path
from . import views

urlpatterns = [
    path('user', views.UserList.as_view()),
]
```
admin 계정을 생성 후 관리자페이지에서 유저목록을 볼 수 있도록 한다.
```shell
python manage.py createsuperuser
...
python manage.py migrate
```

**app.admin.py**
```
from django.contrib import admin
from .models import User


admin.site.register(User)
```
http:localhost:8000/admin 주소로 접속하여 확인 할 수 있다.
  
  
여기까지 django를 이용하여 간단한 jwt구성을 해보았다.  
postman으로 get방식으로 http:localhost:8000/user에 접속하면  
유저 리스트가 뜨지 않는다. 왜나하면 access token을 이용하여 요청하지 않았기 때문이다.  
  
postman body탭의 key와 value 부분에 superuser id와 password를 입력하고  
post방식으로 http://localhost:8000/api-token-auth 주소로 api요청을 하면 token이 발급된다.  

발급된 token값을 이용하여 http:localhost:8000/user 요청을 하면  
정상적으로 유저리스트 값을 볼 수 있다.



# Reference
<https://interconnection.tistory.com/76>

